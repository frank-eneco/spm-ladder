<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladder Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-database.js"></script>

    
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-xl">
                <h1 class="text-3xl font-bold text-center">üèÜ Ladder Tournament</h1>
                <p class="text-center mt-2 opacity-90">Manage rankings and track games</p>
            </div>

            <div class="bg-white shadow-2xl rounded-b-xl overflow-hidden">
                <!-- Add Player Section -->
                <div class="p-6 bg-gray-50 border-b">
                    <h2 class="text-lg font-semibold mb-3 text-gray-800">Add New Player</h2>
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            id="playerName" 
                            placeholder="Enter player name..." 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                            maxlength="30"
                        >
                        <button 
                            id="addPlayerBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200"
                        >
                            Add Player
                        </button>
                    </div>
                </div>

                <!-- Record Game Section -->
                <div class="p-6 bg-blue-50 border-b">
                    <h2 class="text-lg font-semibold mb-3 text-gray-800">Record Game Result</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Winner</label>
                            <select id="winnerSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Select winner...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Loser</label>
                            <select id="loserSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Select loser...</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button 
                                id="recordGameBtn" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                            >
                                Record Game
                            </button>
                        </div>
                    </div>
                    <div id="challengeInfo" class="mt-3 text-sm text-gray-600"></div>
                </div>

                <!-- Ladder Section -->
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            Current Ladder 
                            <span class="text-sm font-normal text-gray-600">(<span id="playerCount">0</span> players)</span>
                        </h2>
                        <button 
                            id="resetBtn" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        >
                            Reset All
                        </button>
                    </div>

                    <!-- Challenge Rules Info -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-yellow-800 mb-2">üìã Challenge Rules</h3>
                        <p class="text-sm text-yellow-700">Players can challenge others up to <strong>2 rungs higher</strong> on the ladder. If the challenger wins, they swap positions with the opponent.</p>
                    </div>

                    <!-- Ladder List -->
                    <div id="ladderContainer" class="space-y-2">
                        <!-- Players will be rendered here -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">üéØ</div>
                        <h3 class="text-lg font-medium mb-2">No Players Yet</h3>
                        <p class="text-sm">Add your first player to start the tournament!</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-12 text-gray-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                        <p>Connecting to database...</p>
                    </div>
                </div>

                <!-- Recent Games Section -->
                <div class="p-6 bg-gray-50 border-t">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Recent Games</h3>
                    <div id="recentGames" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Recent games will be rendered here -->
                    </div>
                    <div id="noGames" class="text-center text-gray-500 py-4">
                        No games recorded yet
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-100 px-6 py-4 text-center text-sm text-gray-600 border-t">
                    <p>üì± Real-time sync ‚Ä¢ üéÆ Game tracking ‚Ä¢ üèÉ Challenge system</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration for Belgium
        const firebaseConfig = {
            apiKey: "AIzaSyCTfDaYZ5e7frfkVQpnJS460a5_xOI2cwA",
            authDomain: "spm-ladder.firebaseapp.com",
            databaseURL: "https://spm-ladder-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "spm-ladder",
            storageBucket: "spm-ladder.firebasestorage.app",
            messagingSenderId: "164520026060",
            appId: "1:164520026060:web:a68ce945f128bec4b38769"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const ladderRef = database.ref('ladder');
        const gamesRef = database.ref('games');

        // DOM Elements
        const playerNameInput = document.getElementById('playerName');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const winnerSelect = document.getElementById('winnerSelect');
        const loserSelect = document.getElementById('loserSelect');
        const recordGameBtn = document.getElementById('recordGameBtn');
        const resetBtn = document.getElementById('resetBtn');
        const ladderContainer = document.getElementById('ladderContainer');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const playerCount = document.getElementById('playerCount');
        const recentGames = document.getElementById('recentGames');
        const noGames = document.getElementById('noGames');
        const challengeInfo = document.getElementById('challengeInfo');

        // State
        let currentLadder = [];
        let currentGames = [];
        let isLoading = true;

        // Show loading initially
        showLoading();

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showEmptyState() {
            emptyState.style.display = 'block';
            ladderContainer.style.display = 'none';
            updatePlayerCount(0);
        }

        function hideEmptyState() {
            emptyState.style.display = 'none';
            ladderContainer.style.display = 'block';
        }

        function showLoading() {
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            ladderContainer.style.display = 'none';
        }

        function hideLoading() {
            loadingState.style.display = 'none';
        }

        function updatePlayerCount(count) {
            playerCount.textContent = count;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium shadow-lg z-50 transform translate-x-full transition-transform duration-300 ${
                type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Player Management Functions
        function addPlayer() {
            const name = playerNameInput.value.trim();
            
            if (!name) {
                showNotification('Please enter a player name', 'error');
                return;
            }

            if (name.length > 30) {
                showNotification('Player name is too long', 'error');
                return;
            }

            if (currentLadder.some(player => player.name === name)) {
                showNotification('Player already exists in the ladder', 'error');
                return;
            }

            const newPlayer = {
                name: name,
                wins: 0,
                losses: 0,
                joinDate: new Date().toISOString()
            };

            currentLadder.push(newPlayer);
            playerNameInput.value = '';
            updateFirebaseLadder();
            showNotification(`${name} added to the ladder!`, 'success');
        }

        function removePlayer(index) {
            if (index < 0 || index >= currentLadder.length) return;
            
            const playerName = currentLadder[index].name;
            if (confirm(`Remove "${playerName}" from the ladder?`)) {
                currentLadder.splice(index, 1);
                updateFirebaseLadder();
                showNotification(`${playerName} removed from the ladder`, 'info');
            }
        }

        function resetLadder() {
            if (currentLadder.length === 0) {
                showNotification('Ladder is already empty', 'info');
                return;
            }
            
            if (confirm('Are you sure you want to reset the entire ladder and all games? This cannot be undone.')) {
                currentLadder = [];
                currentGames = [];
                updateFirebaseLadder();
                gamesRef.set(null);
                showNotification('Ladder and games reset successfully', 'success');
            }
        }

        // Game Management Functions
        function recordGame() {
            const winnerName = winnerSelect.value;
            const loserName = loserSelect.value;

            if (!winnerName || !loserName) {
                showNotification('Please select both winner and loser', 'error');
                return;
            }

            if (winnerName === loserName) {
                showNotification('Winner and loser cannot be the same player', 'error');
                return;
            }

            const winnerIndex = currentLadder.findIndex(p => p.name === winnerName);
            const loserIndex = currentLadder.findIndex(p => p.name === loserName);

            if (winnerIndex === -1 || loserIndex === -1) {
                showNotification('Selected players not found in ladder', 'error');
                return;
            }

            // Check challenge rules: can only challenge up to 2 rungs higher
            if (winnerIndex > loserIndex && (winnerIndex - loserIndex) > 2) {
                showNotification(`${winnerName} can only challenge players up to 2 positions higher`, 'error');
                return;
            }

            // Record the game
            const game = {
                winner: winnerName,
                loser: loserName,
                date: new Date().toISOString(),
                winnerOldPosition: winnerIndex + 1,
                loserOldPosition: loserIndex + 1
            };

            // Update player stats
            currentLadder[winnerIndex].wins++;
            currentLadder[loserIndex].losses++;

            // If challenger (lower ranked) wins, swap positions
            if (winnerIndex > loserIndex) {
                const temp = currentLadder[winnerIndex];
                currentLadder[winnerIndex] = currentLadder[loserIndex];
                currentLadder[loserIndex] = temp;
                
                game.positionSwapped = true;
                game.winnerNewPosition = loserIndex + 1;
                game.loserNewPosition = winnerIndex + 1;
            }

            // Add to games history
            if (!currentGames) currentGames = [];
            currentGames.unshift(game); // Add to beginning
            
            // Keep only last 50 games
            if (currentGames.length > 50) {
                currentGames = currentGames.slice(0, 50);
            }

            // Update Firebase
            updateFirebaseLadder();
            gamesRef.set(currentGames);

            // Clear selections
            winnerSelect.value = '';
            loserSelect.value = '';

            const positionText = game.positionSwapped ? 
                ` (${winnerName} moved from position ${game.winnerOldPosition} to ${game.winnerNewPosition})` : '';
            
            showNotification(`Game recorded: ${winnerName} beat ${loserName}${positionText}`, 'success');
        }

        // Render Functions
        function renderLadder(players) {
            if (!players || players.length === 0) {
                showEmptyState();
                updatePlayerSelects([]);
                return;
            }

            hideEmptyState();
            hideLoading();

            ladderContainer.innerHTML = '';

            players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
                
                playerElement.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full flex items-center justify-center font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800 flex items-center space-x-2">
                                <span>${escapeHtml(player.name)}</span>
                                ${index === 0 ? '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium">üëë Leader</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-500">
                                ${player.wins || 0}W - ${player.losses || 0}L
                                ${player.wins + player.losses > 0 ? ` (${Math.round(player.wins / (player.wins + player.losses) * 100)}% win rate)` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="removePlayer(${index})" class="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-full transition-colors" title="Remove player">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                ladderContainer.appendChild(playerElement);
            });

            updatePlayerCount(players.length);
            updatePlayerSelects(players);
        }

        function updatePlayerSelects(players) {
            winnerSelect.innerHTML = '<option value="">Select winner...</option>';
            loserSelect.innerHTML = '<option value="">Select loser...</option>';

            players.forEach(player => {
                const winnerOption = document.createElement('option');
                winnerOption.value = player.name;
                winnerOption.textContent = player.name;
                winnerSelect.appendChild(winnerOption);

                const loserOption = document.createElement('option');
                loserOption.value = player.name;
                loserOption.textContent = player.name;
                loserSelect.appendChild(loserOption);
            });

            updateChallengeInfo();
        }

        function updateChallengeInfo() {
            const winnerName = winnerSelect.value;
            const loserName = loserSelect.value;

            if (!winnerName || !loserName || winnerName === loserName) {
                challengeInfo.textContent = '';
                return;
            }

            const winnerIndex = currentLadder.findIndex(p => p.name === winnerName);
            const loserIndex = currentLadder.findIndex(p => p.name === loserName);

            if (winnerIndex > loserIndex) {
                const diff = winnerIndex - loserIndex;
                if (diff > 2) {
                    challengeInfo.innerHTML = `<span class="text-red-600">‚ùå Invalid challenge: ${winnerName} can only challenge players up to 2 positions higher</span>`;
                } else {
                    challengeInfo.innerHTML = `<span class="text-green-600">‚úÖ Valid challenge: ${winnerName} (#${winnerIndex + 1}) can challenge ${loserName} (#${loserIndex + 1})</span>`;
                }
            } else {
                challengeInfo.innerHTML = `<span class="text-blue-600">‚ÑπÔ∏è ${winnerName} (#${winnerIndex + 1}) vs ${loserName} (#${loserIndex + 1})</span>`;
            }
        }

        function renderRecentGames(games) {
            if (!games || games.length === 0) {
                recentGames.style.display = 'none';
                noGames.style.display = 'block';
                return;
            }

            noGames.style.display = 'none';
            recentGames.style.display = 'block';
            recentGames.innerHTML = '';

            games.slice(0, 10).forEach(game => {
                const gameElement = document.createElement('div');
                gameElement.className = 'flex justify-between items-center bg-gray-100 px-3 py-2 rounded text-sm';
                
                const date = new Date(game.date).toLocaleDateString();
                const positionInfo = game.positionSwapped ? 
                    ` (positions swapped)` : '';
                
                gameElement.innerHTML = `
                    <span><strong>${escapeHtml(game.winner)}</strong> beat <strong>${escapeHtml(game.loser)}</strong>${positionInfo}</span>
                    <span class="text-gray-500">${date}</span>
                `;
                
                recentGames.appendChild(gameElement);
            });
        }

        // Firebase Functions
        function updateFirebaseLadder() {
            ladderRef.set(currentLadder).catch(error => {
                console.error('Firebase ladder error:', error);
                showNotification('Failed to save ladder changes', 'error');
            });
        }

        // Firebase Listeners
        ladderRef.on('value', (snapshot) => {
            isLoading = false;
            const data = snapshot.val();
            currentLadder = data || [];
            renderLadder(currentLadder);
        }, (error) => {
            isLoading = false;
            console.error('Firebase ladder read error:', error);
            hideLoading();
            showNotification('Failed to connect to database', 'error');
        });

        gamesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            currentGames = data || [];
            renderRecentGames(currentGames);
        });

        // Event Listeners
        addPlayerBtn.addEventListener('click', addPlayer);
        recordGameBtn.addEventListener('click', recordGame);
        resetBtn.addEventListener('click', resetLadder);

        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });

        winnerSelect.addEventListener('change', updateChallengeInfo);
        loserSelect.addEventListener('change', updateChallengeInfo);

        // Focus on input when page loads
        window.addEventListener('load', () => {
            playerNameInput.focus();
        });

        // Global functions for onclick handlers
        window.removePlayer = removePlayer;
    </script>
</body>
</html>
